import{I as h,a as d,b as p,ba as c}from"./chunk-KIKRUHUI.js";var m=class g{VISITS_KEY="clinic_visits";PROCEDURES_KEY="clinic_procedures";PAYMENTS_KEY="clinic_payments";PRESCRIPTIONS_KEY="clinic_prescriptions";visits=c([]);procedures=c([]);payments=c([]);prescriptions=c([]);constructor(){this.loadData()}loadData(){try{let t=localStorage.getItem(this.VISITS_KEY),e=localStorage.getItem(this.PROCEDURES_KEY),i=localStorage.getItem(this.PAYMENTS_KEY),s=localStorage.getItem(this.PRESCRIPTIONS_KEY);this.visits.set(t?JSON.parse(t):[]),this.procedures.set(e?JSON.parse(e):[]),this.payments.set(i?JSON.parse(i):[]),this.prescriptions.set(s?JSON.parse(s):[])}catch(t){console.error("Error loading visit data:",t)}}saveVisits(){localStorage.setItem(this.VISITS_KEY,JSON.stringify(this.visits()))}saveProcedures(){localStorage.setItem(this.PROCEDURES_KEY,JSON.stringify(this.procedures()))}savePayments(){localStorage.setItem(this.PAYMENTS_KEY,JSON.stringify(this.payments()))}savePrescriptions(){localStorage.setItem(this.PRESCRIPTIONS_KEY,JSON.stringify(this.prescriptions()))}createVisit(t){let e={id:"V"+Date.now(),patientId:t,date:new Date().toISOString(),status:"waiting",diagnosis:"",notes:"",totalCost:0};return this.visits.update(i=>[...i,e]),this.saveVisits(),e}getVisitById(t){return this.visits().find(e=>e.id===t)}getVisitsByPatient(t){return this.visits().filter(e=>e.patientId===t).sort((e,i)=>new Date(i.date).getTime()-new Date(e.date).getTime())}getTodayVisits(){let t=new Date().toDateString();return this.visits().filter(e=>new Date(e.date).toDateString()===t).sort((e,i)=>new Date(e.date).getTime()-new Date(i.date).getTime())}updateVisit(t,e){let i=this.visits().findIndex(r=>r.id===t);if(i===-1)throw new Error("Visit not found");let s=d(d({},this.visits()[i]),e);return this.visits.update(r=>{let a=[...r];return a[i]=s,a}),this.saveVisits(),s}startVisit(t){if(this.visits().find(i=>i.status==="in-progress"))throw new Error("Another visit is already in progress. Please complete it first.");return this.updateVisit(t,{status:"in-progress",startedAt:new Date().toISOString()})}completeVisit(t){return this.updateVisit(t,{status:"completed",completedAt:new Date().toISOString()})}deleteVisit(t){this.procedures.update(i=>i.filter(s=>s.visitId!==t)),this.saveProcedures(),this.payments.update(i=>i.filter(s=>s.visitId!==t)),this.savePayments(),this.prescriptions.update(i=>i.filter(s=>s.visitId!==t)),this.savePrescriptions();let e=this.visits().length;return this.visits.update(i=>i.filter(s=>s.id!==t)),this.visits().length<e?(this.saveVisits(),!0):!1}addProcedure(t,e){let i=p(d({},e),{id:"PR"+Date.now(),visitId:t,date:new Date().toISOString()});return this.procedures.update(s=>[...s,i]),this.saveProcedures(),this.updateVisitTotal(t),i}getVisitProcedures(t){return this.procedures().filter(e=>e.visitId===t)}removeProcedure(t){let e=this.procedures().find(i=>i.id===t);return e?(this.procedures.update(i=>i.filter(s=>s.id!==t)),this.saveProcedures(),this.updateVisitTotal(e.visitId),!0):!1}updateVisitTotal(t){let i=this.getVisitProcedures(t).reduce((s,r)=>s+r.price,0);this.updateVisit(t,{totalCost:i})}addPayment(t,e){let i=this.getVisitBalance(t);if(e.amount<=0||e.amount>i)throw new Error("Invalid payment amount");let s=p(d({},e),{id:"PAY"+Date.now(),visitId:t,date:new Date().toISOString()});return this.payments.update(r=>[...r,s]),this.savePayments(),s}getVisitPayments(t){return this.payments().filter(e=>e.visitId===t)}getVisitBalance(t){let e=this.getVisitById(t);if(!e)return 0;let s=this.getVisitPayments(t).reduce((r,a)=>r+a.amount,0);return Math.max(0,e.totalCost-s)}addPrescription(t,e){if(e.length===0)throw new Error("Prescription must have at least one medicine");this.prescriptions.update(s=>s.filter(r=>r.visitId!==t));let i={id:"RX"+Date.now(),visitId:t,items:e,date:new Date().toISOString()};return this.prescriptions.update(s=>[...s,i]),this.savePrescriptions(),i}getVisitPrescription(t){return this.prescriptions().find(e=>e.visitId===t)}getVisitWithDetails(t,e){let i=this.getVisitById(t);if(!i)return null;let s=this.getVisitProcedures(t),r=this.getVisitPayments(t),a=this.getVisitPrescription(t),n=this.getVisitBalance(t),o,l;if(e){let u=e.getPatientById(i.patientId);u&&(o=u.name,l=u.phone)}return p(d({},i),{patientName:o,patientPhone:l,procedures:s,payments:r,prescription:a,balance:n})}getUnpaidVisits(){return this.visits().filter(t=>this.getVisitBalance(t.id)>0)}getDailyStats(t=new Date){let e=t.toDateString(),i=this.visits().filter(n=>new Date(n.date).toDateString()===e),s=this.payments().filter(n=>new Date(n.date).toDateString()===e),r=s.reduce((n,o)=>n+o.amount,0),a=s.reduce((n,o)=>(n[o.method]=(n[o.method]||0)+o.amount,n),{});return{totalVisits:i.length,totalIncome:r,paymentsByMethod:a,transactionCount:s.length}}getFinancialSummary(){let t=this.visits(),e=t.reduce((a,n)=>a+n.totalCost,0),i=this.payments().reduce((a,n)=>a+n.amount,0),s=t.reduce((a,n)=>a+this.getVisitBalance(n.id),0),r=this.getUnpaidVisits().length;return{totalRevenue:e,totalPaid:i,totalOwed:s,unpaidVisitsCount:r,totalVisits:t.length}}filterVisits(t,e){let i=this.visits();return t&&t!=="all"&&(i=i.filter(s=>s.status===t)),e&&(i=i.filter(s=>this.getVisitBalance(s.id)>0)),i.sort((s,r)=>new Date(r.date).getTime()-new Date(s.date).getTime())}static \u0275fac=function(e){return new(e||g)};static \u0275prov=h({token:g,factory:g.\u0275fac,providedIn:"root"})};export{m as a};
